YUI.add("moodle-atto_multilang2-button",function(e,t){var n={TAG:"filter-multilang-tag"},r="%lang",i="%content",s="languages",o="capability",u='{"en":"English (en)"}',a='<span class="'+n.TAG+'">',f="&nbsp;"+a+"{mlang "+r+"}</span>"+i+a+"{mlang}</span>&nbsp;";e.namespace("M.atto_multilang2").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{initializer:function(){var e=this.get(o),t=[];e&&(this._decorateTagsOnInit(),t=this._initializeToolbarItems(),this.addToolbarMenu({globalItemConfig:{callback:this._addTags},icon:"icon",iconComponent:"atto_multilang2",items:t}),this.get("host").on("atto:selectionchanged",this._checkSelectionChange,this),this._setSubmitListener())},_initializeToolbarItems:function(){var e=[],t,n;t=JSON.parse(this.get(s));for(n in t)t.hasOwnProperty(n)&&e.push({text:t[n],callbackArgs:n});return e},_addTags:function(e,t){var n,s=this.get("host"),o=f,u;n=this._getSelectionHTML(),u=s.getSelection().toString().length===0?"&nbsp;":n,o=o.replace(r,t),o=o.replace(i,u),s.insertContentAtFocusPoint(o),this.markUpdated()},_getSelectionHTML:function(){var e="",t,n,r,i;if(typeof window.getSelection!="undefined"){t=window.getSelection();if(t.rangeCount){n=document.createElement("div");for(r=0,i=t.rangeCount;r<i;++r)n.appendChild(t.getRangeAt(r).cloneContents());e=n.innerHTML}}else typeof document.selection!="undefined"&&document.selection.type==="Text"&&(e=document.selection.createRange().htmlText);return e},_checkSelectionChange:function(){var t=this.get("host"),n=t.getSelectionParentNode(),r=e.one(n).get("text"),i,s;i=e.one(n).toString().indexOf("#text")>-1,s=r.match(/\{mlang/g).length===1,i&&s&&t.setSelection(t.getSelectionFromNode(e.one(n)))},_setSubmitListener:function(){var t=e.one("#id_submitbutton");t.on("click",this._cleanTagsOnSubmit,this)},_cleanTagsOnSubmit:function(t){var n=e.one("#id_submitbutton");t.preventDefault(),this._cleanTagsWithNoYuiId(),this._cleanTagsWithYuiId(),this.detach(),n.simulate("click")},_cleanTagsWithNoYuiId:function(){var t,n,r,i,s,o,u;t=e.one("#id_messageeditable"),n=t.get("innerHTML"),u=new RegExp(a+".*?"+"</span>","g"),r=n.match(u);if(r!==null){for(s=0;s<r.length;s++)i=r[s],o=i.replace(a,""),o=o.replace("</span>",""),n=n.replace(i,o);t.set("innerHTML",n),this.markUpdated()}},_cleanTagsWithYuiId:function(){var t,n,r,i,s,o,u,f,l;t=e.one("#id_messageeditable"),n=t.get("innerHTML"),u=a.replace("<span",'<span id="yui_.*?"'),o=new RegExp(u+".*?{mlang.*?}</span>","g"),f=n.match(o);if(f!==null){for(i=0;i<f.length;i++)r=f[i],l=r.match(/\{mlang.*?\}/g)[0],s=r.replace(o,l),s=s.replace("</span>",""),n=n.replace(r,s);t.set("innerHTML",n),this.markUpdated()}},_decorateTagsOnInit:function(){var t=e.one("#id_messageeditable"),n,r,i,s,o,u;n=this._getHTMLwithCleanedTags(),r=new RegExp("{mlang.*?}","g"),i=n.match(r);if(i!==null){for(o=0;o<i.length;o++)s=i[o],u=a+s+"</span>",n=n.replace(s,u);t.set("innerHTML",n)}},_getHTMLwithCleanedTags:function(){var t=e.one("#id_messageeditable"),n=t.get("innerHTML"),r,i,s,o,u,f;r=a+".*?"+"</span>",i=new RegExp(r,"g"),s=n.match(i);if(s!==null)for(f=0;f<s.length;f++)o=s[f],u=o.replace(a,""),u=u.replace("</span>",""),n=n.replace(o,u);return n}},{ATTRS:{languages:u,capability:!0}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});
