YUI.add("moodle-atto_multilang2-button",function(a,t){var o="filter-multilang-tag",l="%lang",s="%content",h='<span class="'+o+'">',g="</span>",e={SPANNED:"&nbsp;"+h+"{mlang "+l+"}"+g+s+h+"{mlang}"+g+"&nbsp;",NOT_SPANNED:"{mlang %lang}"+s+"{mlang}"};a.namespace("M.atto_multilang2").Button=a.Base.create("button",a.M.editor_atto.EditorPlugin,[],{_highlight:!0,initializer:function(){var t;this.get("capability")&&(t=this._initializeToolbarItems(),this.addToolbarMenu({globalItemConfig:{callback:this._addTags},icon:"icon",iconComponent:"atto_multilang2",items:t}),this._tagTemplate=e.NOT_SPANNED,this._highlight=this.get("highlight"),this._highlight&&(this._tagTemplate=e.SPANNED,(t=this.get("host").textarea.ancestor("form"))&&t.on("submit",this._cleanMlangTags,this),this.get("host").on("atto:selectionchanged",this._checkSelectionChange,this),this.get("host").on("pluginsloaded",this._addHighlightingCss,this),this.get("host").on("pluginsloaded",this._highlightMlangTags,this),this._hookUpdateOriginal(),this._hookUpdateFromTextArea()))},_initializeToolbarItems:function(){var t,e=[],i=JSON.parse(this.get("languages"));for(t in i)i.hasOwnProperty(t)&&e.push({text:i[t],callbackArgs:t});return e},_addHighlightingCss:function(){var t="."+o+" {"+this.get("css")+"}",e=document.createElement("style");e.type="text/css",e.innerHTML=t,document.head.appendChild(e)},_hookUpdateOriginal:function(){var t,e=this.get("host"),i=this;e.updateOriginal=(t=e.updateOriginal,function(){return i._highlight&&this.updateOriginal.caller===e.plugins.html._showHTML&&i.editor.setHTML(i._getHTMLwithCleanedTags(i.editor.getHTML())),t.apply(this,arguments)})},_hookUpdateFromTextArea:function(){var e,i=this.get("host"),n=this;i.updateFromTextArea=(e=i.updateFromTextArea,function(){var t=e.apply(this,arguments);return n._highlight&&this.updateFromTextArea.caller===i.plugins.html._showHTML&&n._highlightMlangTags(),t})},_addTags:function(t,e){var i=this.get("host"),n=this._tagTemplate,a=this._getSelectionHTML(),a=0===i.getSelection().toString().length?"&nbsp;":a;n=(n=n.replace(l,e)).replace(s,a),i.insertContentAtFocusPoint(n),this.markUpdated()},_getSelectionHTML:function(){var t,e,i,n,a="";if("undefined"!=typeof window.getSelection){if((t=window.getSelection()).rangeCount){for(e=document.createElement("div"),i=0,n=t.rangeCount;i<n;++i)e.appendChild(t.getRangeAt(i).cloneContents());a=e.innerHTML}}else"undefined"!=typeof document.selection&&"Text"===document.selection.type&&(a=document.selection.createRange().htmlText);return a},_checkSelectionChange:function(){var t,e,i=this.get("host"),n=i.getSelectionParentNode();null!=n&&!1!==n&&"undefined"!=typeof n.parentNode&&null!==n.parentNode&&(e=n.parentNode.nodeName,t=n.parentNode.hasAttribute("class")?n.parentNode.getAttribute("class"):"",null!=e&&""!==t&&"SPAN"===e&&-1!==t.indexOf(o)&&(e=i.getSelectionFromNode(a.one(n)),i.setSelection(e)))},_cleanMlangTags:function(){this._highlight&&(this.editor.setHTML(this._getHTMLwithCleanedTags(this.editor.getHTML())),this.markUpdated())},_highlightMlangTags:function(){var t,e,i,n,a,o,l=[];if(this._highlight){if(t=this._getHTMLwithCleanedTags(this.editor.getHTML()),e=new RegExp("{mlang.*?}","g"),null!==(i=t.match(e))){for(a=0;a<i.length;a++)n=i[a],-1===l.indexOf(n)&&(l.push(n),o=h+n+g,e=new RegExp(n,"g"),t=t.replace(e,o));this.editor.setHTML(t)}this.markUpdated()}},_getHTMLwithCleanedTags:function(t){var e=document.createElement("div");return e.innerHTML=t,t=e.getElementsByTagName("span"),Array.prototype.slice.call(t,0).forEach(function(t){if(-1!==t.className.indexOf(o)){for(;t.firstChild;)t.parentNode.insertBefore(t.firstChild,t);t.parentNode.removeChild(t)}}),e.innerHTML}},{ATTRS:{languages:'{"en":"English (en)"}',capability:!0,highlight:!0,css:"outline: 1px dotted;padding: 0.1em;margin: 0em 0.1em;background-color: #ffffaa;"}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});